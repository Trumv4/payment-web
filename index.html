<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Trang Web Thanh To√°n By T√∫</title>

<!-- √°p theme s·ªõm -->
<script>
(()=>{ const t=localStorage.getItem('theme'); if(t==='light')document.documentElement.classList.remove('dark'); else document.documentElement.classList.add('dark'); })();
</script>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  :root{--bg:#f6f8fe;--card:#ffffff;--border:#e7eaf3;--txt:#0f172a;--sub:#5b6476}
  html.dark{--bg:#0b1220;--card:#0f172a;--border:#18243b;--txt:#e6ecff;--sub:#98a3b8}
  html,body{background:var(--bg);color:var(--txt)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px}
  .subtle{color:var(--sub)}
  .inp{width:100%;padding:.78rem .9rem;border:1px solid var(--border);border-radius:.9rem;background:var(--card);color:var(--txt)}
  .readonly{background:rgba(148,163,184,.12)}
  .lbl{display:block;font-size:.95rem;font-weight:700;margin-bottom:.35rem}

  /* Header + wave */
  .header-hero{position:relative;border-radius:18px;padding:18px 16px}
  .header-waves{position:absolute;inset:0 0 -40% 0;z-index:0;pointer-events:none}
  .hw{position:absolute;left:0;right:0;bottom:-1px;height:120px;width:200%;background-repeat:repeat-x;background-size:50% 120px;animation:hw 18s linear infinite;opacity:.85}
  .hw:nth-child(1){background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="120"><path fill="%23eef2ff" d="M0 50C270 230 830 -110 1600 50V120H0z"/></svg>')}
  .hw:nth-child(2){background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="120"><path fill="%23e5ecff" d="M0 60C270 240 830 -100 1600 60V120H0z"/></svg>');animation-duration:22s;bottom:8px}
  .hw:nth-child(3){background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="120"><path fill="%23dde7ff" d="M0 70C270 250 830 -90 1600 70V120H0z"/></svg>');animation-duration:28s;bottom:16px}
  @keyframes hw{from{transform:translateX(0)}to{transform:translateX(-50%)}}

  /* Title: Light c√≥ vi·ªÅn, Dark 7 m√†u */
  .brand-title{position:relative;z-index:1;font-size:clamp(22px,4.2vw,44px);font-weight:900;letter-spacing:.3px;text-transform:uppercase;line-height:1.1;white-space:nowrap}
  .brand-title .t-main{color:#0f172a;text-shadow:0 1px 0 #fff,0 2px 0 rgba(255,255,255,.9),0 3px 2px rgba(0,0,0,.08),0 6px 12px rgba(0,0,0,.06)}
  .brand-title .t-name{color:#4f46e5;text-shadow:0 1px 0 #fff,0 2px 0 rgba(255,255,255,.9),0 3px 2px rgba(79,70,229,.18),0 6px 12px rgba(79,70,229,.12)}
  html.dark .brand-title{background:linear-gradient(270deg, red, orange, yellow, green, cyan, blue, violet, red);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-size:1400% 1400%;animation:brandRainbow 8s ease infinite}
  html.dark .brand-title .t-main, html.dark .brand-title .t-name{ text-shadow:none }
  @keyframes brandRainbow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
  @media (max-width:420px){ .brand-title{white-space:normal;text-wrap:balance;font-size:clamp(18px,6vw,28px)} }

  /* Waves bottom */
  .wave-bg{position:fixed;inset:auto 0 0 0;height:40vh;z-index:-1;pointer-events:none}
  .wave{position:absolute;left:0;right:0;bottom:-1px;height:140px;width:200%;background-repeat:repeat-x;background-size:50% 140px;animation:wm 20s linear infinite}
  .wave:nth-child(1){background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="140"><path fill="%23d9ecff" d="M0 70C270 270 830 -130 1600 70V140H0z"/></svg>')}
  .wave:nth-child(2){background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="140"><path fill="%23e7f2ff" d="M0 82C270 282 830 -118 1600 82V140H0z"/></svg>');animation-duration:26s;bottom:12px;opacity:.9}
  .wave:nth-child(3){background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="140"><path fill="%23f1f8ff" d="M0 94C270 294 830 -106 1600 94V140H0z"/></svg>');animation-duration:32s;bottom:24px;opacity:.8}
  @keyframes wm{from{transform:translateX(0)}to{transform:translateX(-50%)}}

  /* Bank cards */
  .bank-card{display:flex;align-items:center;gap:.8rem;padding:1rem;border:1px solid var(--border);
             border-radius:14px;background:var(--card);cursor:pointer;transition:.18s box-shadow,.12s border-color}
  .bank-card:hover{box-shadow:0 8px 22px rgba(2,6,23,.08)}
  .bank-card.active{border-color:#6366f1;box-shadow:0 8px 28px rgba(99,102,241,.22)}
  .chip{margin-left:auto;font-size:.72rem;padding:.25rem .6rem;border-radius:.6rem;background:#eef2ff;color:#334155}
  html.dark .chip{background:#15223a;color:#cbd5e1}
  .bank-logo{height:28px;width:auto;object-fit:contain}

  /* Wave text + ripple button */
  .wave-text{font-weight:800;letter-spacing:.4px;background:linear-gradient(90deg,#0ea5e9,#1e293b,#0ea5e9);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:tw 3.6s linear infinite}
  @keyframes tw{0%{background-position:0% 50%}100%{background-position:200% 50%}}
  .btn-ripple{position:relative;overflow:hidden;background:linear-gradient(180deg,#1e293b,#0b1023);color:#fff;border:2px solid rgba(255,255,255,.9);border-radius:12px;padding:.7rem 1rem;font-weight:800}
  .btn-ripple .r{position:absolute;border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;background:radial-gradient(circle,rgba(99,102,241,.55) 0, rgba(99,102,241,.25) 40%, rgba(99,102,241,0) 70%)}
  .btn-ripple:hover{filter:brightness(1.08)} .btn-ripple:active{transform:scale(.98)}
  .tap-btn{min-height:44px;min-width:44px}

  #btnMusic{background:#4452ff;color:#fff;border:2px solid #fff;box-shadow:0 6px 20px rgba(68,82,255,.25)}
  #btnMusic.active{background:#ff4d6d}
  #btnTheme{border:2px solid #fff}

  .rainbow-text{font-weight:800;font-size:28px;text-align:center;margin:40px 0;text-transform:uppercase;white-space:nowrap;background:linear-gradient(270deg, red, orange, yellow, green, cyan, blue, violet, red);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-size:1400% 1400%;animation:rainbowFlow 8s ease infinite}
  @keyframes rainbowFlow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

  .video-wrap{position:relative;padding-top:56.25%;border-radius:14px;overflow:hidden;background:#000}
  .video-wrap iframe{position:absolute;inset:0;width:100%;height:100%;border:0}

  @media (max-width:480px){
    #btnTheme{ position: fixed; right: 12px; top: 12px; z-index: 60; }
    #btnMusic{ position: fixed; right: 64px; top: 12px; z-index: 60; }
    .card{padding:16px}
  }
</style>
</head>
<body class="dark">

  <!-- Header -->
  <div class="max-w-5xl mx-auto px-4 pt-5 pb-3 flex items-center justify-between header-hero">
    <div class="header-waves"><div class="hw"></div><div class="hw"></div><div class="hw"></div></div>
    <h1 class="brand-title"><span class="t-main">TRANG WEB THANH TO√ÅN</span>&nbsp;<span class="t-name">BY T√ö</span></h1>
    <div class="flex items-center gap-2 shrink-0">
      <button id="btnTheme" class="tap-btn px-3 py-1.5 rounded-lg" aria-label="ƒê·ªïi n·ªÅn">üåì</button>
      <button id="btnMusic" class="tap-btn px-3 py-1.5 rounded-lg active" aria-label="B·∫≠t/t·∫Øt video nh·∫°c">‚è∏</button>
    </div>
  </div>

  <main class="max-w-5xl mx-auto px-4 pb-24">
    <!-- Bank ch·ªçn (t√†i kho·∫£n nh·∫≠n) -->
    <section class="card p-5 sm:p-6 mb-6">
      <h2 class="font-semibold mb-4 text-lg">Ch·ªçn Ng√¢n H√†ng & Th√¥ng tin ng∆∞·ªùi nh·∫≠n</h2>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
        <!-- MB -->
        <label class="bank-card active" id="cardMB">
          <input type="radio" name="bank" value="MB" class="hidden" checked />
          <img class="bank-logo" src="assets/mb.png" alt="MB Bank"
            onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<?xml version=&quot;1.0&quot;?><svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 64 64&quot;><rect width=&quot;64&quot; height=&quot;64&quot; rx=&quot;12&quot; fill=&quot;%23e11d48&quot;/><text x=&quot;32&quot; y=&quot;38&quot; font-size=&quot;28&quot; font-weight=&quot;800&quot; fill=&quot;white&quot; text-anchor=&quot;middle&quot; font-family=&quot;Arial&quot;>MB</text></svg>';">
          <div class="min-w-0">
            <div class="font-semibold leading-tight">MB Bank</div>
            <div class="text-xs subtle truncate">STK 0326615531 ‚Ä¢ Pham Anh Tu</div>
          </div>
          <span class="chip">ƒêang ch·ªçn</span>
        </label>

        <!-- VCB -->
        <label class="bank-card" id="cardVCB">
          <input type="radio" name="bank" value="VCB" class="hidden" />
          <img class="bank-logo" src="assets/vcb.png" alt="Vietcombank"
            onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,<?xml version=&quot;1.0&quot;?><svg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 64 64&quot;><rect width=&quot;64&quot; height=&quot;64&quot; rx=&quot;12&quot; fill=&quot;%2316a34a&quot;/><path d=&quot;M20 38c6-8 10-12 12-12s6 4 12 12-6 12-12 12-18-4-12-12z&quot; fill=&quot;white&quot;/></svg>';">
          <div class="min-w-0">
            <div class="font-semibold leading-tight">Vietcombank</div>
            <div class="text-xs subtle truncate">STK 9965003865 ‚Ä¢ Pham Anh Tu</div>
          </div>
          <span class="chip hidden">ƒêang ch·ªçn</span>
        </label>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        <div>
          <label class="lbl">Ng√¢n h√†ng (ƒëang ch·ªçn)</label>
          <input id="bankName" class="inp readonly" value="MB Bank" readonly />
        </div>
        <div>
          <label class="lbl">S·ªë t√†i kho·∫£n</label>
          <input id="account" class="inp readonly" value="0326615531" readonly />
        </div>
        <div>
          <label class="lbl">Ch·ªß t√†i kho·∫£n</label>
          <input class="inp readonly" value="Pham Anh Tu" readonly />
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
        <div>
          <label class="lbl">Ki·ªÉu ·∫£nh QR</label>
          <select id="qrStyle" class="inp">
            <option value="compact" selected>compact (logo + th√¥ng tin)</option>
            <option value="qr_only">qr_only (ch·ªâ QR)</option>
          </select>
        </div>
        <div>
          <label class="lbl">T·ª± copy ND sau khi t·∫°o</label>
          <select id="autoCopy" class="inp">
            <option value="1" selected>C√≥</option>
            <option value="0">Kh√¥ng</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Form -->
    <section class="card p-5 sm:p-6">
      <h2 class="font-semibold mb-4 text-lg">Th√¥ng tin ƒë∆°n h√†ng</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label class="lbl">S·∫£n ph·∫©m / d·ªãch v·ª•</label>
          <select id="product" class="inp">
            <option value="VIEON">VieON</option>
            <option value="NETFLIX" selected>Netflix</option>
            <option value="MUAVANG">Mua V√†ng</option>
            <option value="MUANGOC">Mua Ng·ªçc</option>
            <option value="MUAACC">Mua Acc</option>
            <option value="DVK">D·ªãch v·ª• kh√°c</option>
          </select>
        </div>
        <div>
          <label class="lbl">S·ªë ti·ªÅn (VNƒê)</label>
          <input id="amount" type="text" inputmode="numeric" placeholder="VD: 10.000" class="inp" />
          <p id="amountErr" class="mt-1 text-sm text-rose-500 hidden">S·ªë ti·ªÅn t·ªëi thi·ªÉu l√† <b>10.000ƒë</b>.</p>
          <p class="text-xs mt-1 text-rose-500">* D∆∞·ªõi 10k & <b>sai n·ªôi dung</b> s·∫Ω <u>kh√¥ng ho√†n</u>.</p>
        </div>
      </div>

      <div class="mt-3">
        <label class="lbl">Email kh√°ch (t√πy ch·ªçn)</label>
        <input id="email" type="email" placeholder="example@gmail.com" class="inp" />
      </div>

      <button id="btnCreate" class="mt-4 w-full sm:w-auto px-6 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-semibold tap-btn">
        T·∫°o QR
      </button>
    </section>

    <!-- K·∫øt qu·∫£ -->
    <section id="qrWrap" class="mt-6"></section>

    <!-- Li√™n h·ªá -->
    <section class="card p-5 sm:p-6 mt-6">
      <h2 class="font-semibold mb-3 text-lg">Li√™n h·ªá nhanh</h2>
      <div class="flex flex-wrap gap-3">
        <a href="https://zalo.me/0326615531" target="_blank" rel="noopener" class="btn-ripple tap-btn px-4 py-2 rounded-lg"><span class="r"></span>üí¨ M·ªü Zalo</a>
        <a href="https://www.facebook.com/thanhxuanngungoc" target="_blank" rel="noopener" class="btn-ripple tap-btn px-4 py-2 rounded-lg"><span class="r"></span>üëç M·ªü Facebook</a>
      </div>
    </section>

    <!-- Video YouTube -->
    <section class="card p-5 sm:p-6 mt-6" id="video">
      <h2 class="font-semibold mb-3 text-lg">Video nh·∫°c</h2>
      <div class="video-wrap">
        <iframe id="yt-player"
          src="https://www.youtube.com/embed/I21BpYYoMsk?enablejsapi=1&rel=0&modestbranding=1&playsinline=1"
          title="YouTube video" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
      </div>
      <p class="text-xs subtle mt-2">* N√∫t üéµ ·ªü g√≥c tr√™n s·∫Ω ph√°t/t·∫°m d·ª´ng video n√†y. B·∫•m video c≈©ng ƒë·ªìng b·ªô n√∫t.</p>
    </section>

    <footer class="mt-10 text-center">
      <h2 class="rainbow-text">DESIGIN BY T√ö</h2>
    </footer>
  </main>

  <!-- Waves bottom -->
  <div class="wave-bg"><div class="wave"></div><div class="wave"></div><div class="wave"></div></div>

<script>
  /* ===== THEME ===== */
  const btnTheme=document.getElementById('btnTheme');
  const toggleTheme=()=>{ const r=document.documentElement; r.classList.toggle('dark'); localStorage.setItem('theme', r.classList.contains('dark')?'dark':'light'); };
  btnTheme.addEventListener('click', toggleTheme, {passive:true});
  btnTheme.addEventListener('touchstart', (e)=>{e.preventDefault();toggleTheme();},{passive:false});

  /* ===== YOUTUBE sync v·ªõi n√∫t üéµ ===== */
  const btnMusic=document.getElementById('btnMusic');
  let ytApiLoaded=false, ytPlayer=null, ytReady=false;
  function loadYTApi(){ if(ytApiLoaded) return; ytApiLoaded=true;
    const s=document.createElement('script'); s.src="https://www.youtube.com/iframe_api"; document.head.appendChild(s);
    window.onYouTubeIframeAPIReady=function(){
      ytPlayer=new YT.Player('yt-player',{events:{
        onReady:()=>{ ytReady=true },
        onStateChange:(e)=>{ if(e.data===1){btnMusic.classList.add('active');btnMusic.textContent='‚è∏'} if(e.data===2||e.data===0){btnMusic.classList.remove('active');btnMusic.textContent='‚ñ∂'} }
      }});
    };
  }
  loadYTApi();
  btnMusic.addEventListener('click', ()=>{ if(!ytReady) return; const s=ytPlayer.getPlayerState(); if(s===YT.PlayerState.PLAYING) ytPlayer.pauseVideo(); else ytPlayer.playVideo(); });

  /* ===== Receiver (t√†i kho·∫£n nh·∫≠n) ===== */
  const BANKS={ MB:{code:"MB",name:"MB Bank",account:"0326615531"}, VCB:{code:"VCB",name:"Vietcombank",account:"9965003865"} };
  let currentBank="MB";
  const cardMB=document.getElementById('cardMB');
  const cardVCB=document.getElementById('cardVCB');
  function setBank(key){
    currentBank=key;
    cardMB.classList.toggle('active', key==="MB");
    cardVCB.classList.toggle('active', key==="VCB");
    cardMB.querySelector('.chip').classList.toggle('hidden', key!=="MB");
    cardVCB.querySelector('.chip').classList.toggle('hidden', key!=="VCB");
    const info=BANKS[key];
    document.getElementById('bankName').value=info.name;
    document.getElementById('account').value=info.account;
  }
  cardMB.addEventListener('click',()=>setBank("MB"));
  cardVCB.addEventListener('click',()=>setBank("VCB"));
  setBank("MB");

  /* ===== Format s·ªë ti·ªÅn ===== */
  const MIN_AMOUNT=10000;
  const parseAmt=v=>Number(String(v).replace(/[^\d]/g,""));
  const nf=new Intl.NumberFormat('vi-VN');
  const amtInput=document.getElementById('amount'), amtErr=document.getElementById('amountErr');
  amtInput.addEventListener('input',()=>{
    const raw=parseAmt(amtInput.value);
    amtInput.value=raw?nf.format(raw):"";
    if(raw && raw<MIN_AMOUNT) amtErr.classList.remove('hidden'); else amtErr.classList.add('hidden');
  });

  /* ===== VietQR ===== */
  function buildVietQRUrl(bank, account, amount, addInfo, style="compact"){
    const base=`https://img.vietqr.io/image/${bank}-${account}-${style}.png`;
    const qs=new URLSearchParams();
    if(amount && Number(amount)>0) qs.set("amount", String(Number(amount)));
    qs.set("addInfo", addInfo);
    return `${base}?${qs.toString()}`;
  }

  /* ===== Helpers ===== */
  const rand4=()=>String(Math.floor(Math.random()*10000)).padStart(4,"0");
  const makeND=prod=>`DV-${prod}-GEN${rand4()}`;
  let timer=null;
  function startCountdown(expireAt,onTick,onDone){
    if(timer) clearInterval(timer);
    function up(){ const left=expireAt-Date.now(); if(left<=0){ clearInterval(timer); onDone(); return; }
      const m=Math.floor(left/60000), s=Math.floor((left%60000)/1000);
      onTick(`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`); }
    up(); timer=setInterval(up,1000);
  }
  function ripple(e){
    const btn=e.currentTarget, r=document.createElement('span'); r.className='r';
    const rc=btn.getBoundingClientRect(); r.style.width=r.style.height=Math.max(rc.width,rc.height)+'px';
    r.style.left=(e.clientX-rc.left)+'px'; r.style.top=(e.clientY-rc.top)+'px';
    btn.appendChild(r); setTimeout(()=>r.remove(),450);
  }
  function copyTxt(t){ navigator.clipboard.writeText(t); }

  /* ===== Open app ng√¢n h√†ng: iOS fix + c√¥ng t·∫Øc kh√¥ng fallback AppStore ===== */
  const isiOS = () => /iPhone|iPad|iPod/i.test(navigator.userAgent);
  const isAndroid = () => /Android/i.test(navigator.userAgent);

  const BANK_APPS = {
    MB:  { iosTry:["mbbank://"],
           iosStore:"https://apps.apple.com/vn/app/mb-bank/id1205807363",
           androidIntent:"intent://open#Intent;scheme=mbbank;package=com.mbmobile;end",
           androidStore:"https://play.google.com/store/apps/details?id=com.mbmobile" },
    VCB: { iosTry:["vcbdigibank://","vcbpay://"],
           iosStore:"https://apps.apple.com/vn/app/vietcombank-digibank/id1501691447",
           androidIntent:"intent://open#Intent;scheme=vcbdigibank;package=com.vcb.digibank;end",
           androidStore:"https://play.google.com/store/apps/details?id=com.vcb.digibank" },
    TCB: { iosTry:["techcombank://","tcbbank://"],
           iosStore:"https://apps.apple.com/vn/app/techcombank/id1354037072",
           androidIntent:"intent://open#Intent;scheme=techcombank;package=com.techcombank.bb.app;end",
           androidStore:"https://play.google.com/store/apps/details?id=com.techcombank.bb.app" },
    BIDV:{ iosTry:["bidv://","smartbankingbidv://"],
           iosStore:"https://apps.apple.com/vn/app/bidv-smartbanking/id1067337309",
           androidIntent:"intent://open#Intent;scheme=bidv;package=com.bidv.smartbanking;end",
           androidStore:"https://play.google.com/store/apps/details?id=com.bidv.smartbanking" },
    ACB: { iosTry:["acb://"],
           iosStore:"https://apps.apple.com/vn/app/acb-one-bank/id1516594789",
           androidIntent:"intent://open#Intent;scheme=acb;package=com.vnpay.ACB;end",
           androidStore:"https://play.google.com/store/apps/details?id=com.vnpay.ACB" },
    VPB: { iosTry:["vpbank://","vpbankneo://"],
           iosStore:"https://apps.apple.com/vn/app/vpbank-neo/id1507663168",
           androidIntent:"intent://open#Intent;scheme=vpbank;package=com.vpbank.smartbanking;end",
           androidStore:"https://play.google.com/store/apps/details?id=com.vpbank.smartbanking" },
    TPB: { iosTry:["tpbank://","tpb://"],
           iosStore:"https://apps.apple.com/vn/app/tpbank-mobile/id503181250",
           androidIntent:"intent://open#Intent;scheme=tpb;package=com.tpb.mb.gprsandroid;end",
           androidStore:"https://play.google.com/store/apps/details?id=com.tpb.mb.gprsandroid" },
    CTG: { iosTry:["vietinbank://","ipayvietinbank://"],
           iosStore:"https://apps.apple.com/vn/app/vietinbank-ipay/id1060753214",
           androidIntent:"intent://open#Intent;scheme=vietinbank;package=com.vietinbank.ipay;end",
           androidStore:"https://play.google.com/store/apps/details?id=com.vietinbank.ipay" }
  };

  function tryOpenIOSOnce(url, timeout=2500){
    return new Promise(resolve=>{
      let opened = false, tid;
      const onHide = () => { opened = true; cleanup(); resolve(true); };
      const cleanup = () => { document.removeEventListener('visibilitychange', onHide); clearTimeout(tid); if(ifr && ifr.remove) ifr.remove(); };

      document.addEventListener('visibilitychange', onHide, { once:true });

      // 1) iframe ·∫©n
      const ifr = document.createElement('iframe');
      ifr.style.display = 'none';
      ifr.src = url;
      document.body.appendChild(ifr);

      // 2) th√™m location sau 300ms
      setTimeout(()=>{ try{ window.location = url; }catch(e){} }, 300);

      tid = setTimeout(()=>{ if(!opened){ cleanup(); resolve(false); } }, timeout);
    });
  }

  async function openBankApp(bankKey, nd, amount){
    // Copy ND + s·ªë ti·ªÅn tr∆∞·ªõc
    try{ await navigator.clipboard.writeText(`ND: ${nd} | S·ªë ti·ªÅn: ${Number(amount).toLocaleString('vi-VN')}ƒë`);}catch(e){}

    const cfg = BANK_APPS[bankKey];
    if(!cfg){ alert("Ch∆∞a c·∫•u h√¨nh deeplink cho ng√¢n h√†ng n√†y.\nND & s·ªë ti·ªÅn ƒë√£ copy, h√£y m·ªü app v√† d√°n."); return; }

    const noStoreFallback = !!document.getElementById('noStoreFallback')?.checked;

    if(/Android/i.test(navigator.userAgent)){
      const toStore = ()=>{ if(!noStoreFallback) location.href = cfg.androidStore; };
      try{
        const t = setTimeout(toStore, 1700);
        location.href = cfg.androidIntent;        // m·ªü app
        setTimeout(()=>clearTimeout(t), 3500);     // m·ªü th√†nh c√¥ng -> hu·ª∑ fallback
      }catch(e){ toStore(); }
      return;
    }

    if(/iPhone|iPad|iPod/i.test(navigator.userAgent)){
      for(const scheme of (cfg.iosTry||[])){
        const ok = await tryOpenIOSOnce(scheme, 2500);
        if(ok) return; // trang b·ªã ·∫©n => app ƒë√£ m·ªü
      }
      if(!noStoreFallback){
        location.href = cfg.iosStore; // fallback AppStore
      }else{
        alert("Kh√¥ng m·ªü ƒë∆∞·ª£c app t·ª± ƒë·ªông.\nND & s·ªë ti·ªÅn ƒë√£ copy. Vui l√≤ng m·ªü app ng√¢n h√†ng v√† d√°n ND.");
      }
      return;
    }

    // Desktop
    if(!noStoreFallback){
      location.href = cfg.androidStore || cfg.iosStore || 'https://google.com';
    }
  }

  /* ===== Build & render QR ===== */
  function buildVietQR(nd, amount, style, bankKey){
    const info=(bankKey==='MB')?{code:'MB',account:'0326615531'}:{code:'VCB',account:'9965003865'};
    return buildVietQRUrl(info.code, info.account, amount, nd, style);
  }

  function renderResult(nd, qrUrl, amount, email, expireAt, bankKey){
    const RECEIVER = { MB:{name:'MB Bank', account:'0326615531'}, VCB:{name:'Vietcombank', account:'9965003865'} }[bankKey];
    const amtFmt=Number(amount||0).toLocaleString("vi-VN");
    const wrap=document.getElementById('qrWrap');

    wrap.innerHTML=`
      <div id="qrCard" class="card p-5 sm:p-6">
        <div class="text-center">
          <p class="text-sm subtle">Ng∆∞·ªùi nh·∫≠n: <b>Pham Anh Tu</b> ‚Ä¢ <b>${RECEIVER.name}</b></p>
          <img id="qrImg" src="${qrUrl}" alt="QR VietQR" class="mx-auto mt-3 rounded-xl border p-2 bg-white max-w-[260px]" />
          <p class="text-xs subtle mt-2">Qu√©t m√£ s·∫Ω t·ª± ƒëi·ªÅn s·ªë ti·ªÅn <b>${amtFmt}ƒë</b> v√† ND nh∆∞ b√™n d∆∞·ªõi.</p>
        </div>

        <div class="grid grid-cols-1 gap-3 mt-4">
          <div class="border rounded-xl p-3">
            <div class="text-xs subtle mb-1">N·ªôi dung chuy·ªÉn kho·∫£n</div>
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div class="wave-text text-lg break-all">${nd}</div>
              <button class="btn-ripple tap-btn" onclick="copyTxt('${nd}')" onmousedown="ripple(event)">Copy ND</button>
            </div>
          </div>
          <div class="border rounded-xl p-3">
            <div class="text-xs subtle mb-1">S·ªë t√†i kho·∫£n ƒëang d√πng (${RECEIVER.name})</div>
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
              <div class="wave-text text-lg">${RECEIVER.account}</div>
              <button class="btn-ripple tap-btn" onclick="copyTxt('${RECEIVER.account}')" onmousedown="ripple(event)">Copy STK</button>
            </div>
          </div>
        </div>

        <div class="mt-4 space-y-2">
          <label class="flex items-center gap-2 text-sm">
            <input id="noStoreFallback" type="checkbox" class="h-4 w-4">
            <span>ƒê√É C√ÄI APP ‚Äì KH√îNG CHUY·ªÇN APP STORE n·∫øu kh√¥ng m·ªü ƒë∆∞·ª£c</span>
          </label>

          <button class="btn-ripple tap-btn w-full" onmousedown="ripple(event)"
                  onclick="openBankApp('${bankKey}','${nd}',${amount})">
            M·ªü App Ng√¢n H√†ng (t·ª± ƒëi·ªÅn ND & s·ªë ti·ªÅn)
          </button>
        </div>

        <div class="mt-5">
          <h3 class="font-semibold mb-2 text-base">Ho·∫∑c m·ªü <span class="underline">app ng√¢n h√†ng c·ªßa b·∫°n</span>:</h3>
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
            <button class="btn-ripple tap-btn" onmousedown="ripple(event)" onclick="openBankApp('MB','${nd}',${amount})">MB Bank</button>
            <button class="btn-ripple tap-btn" onmousedown="ripple(event)" onclick="openBankApp('VCB','${nd}',${amount})">Vietcombank</button>
            <button class="btn-ripple tap-btn" onmousedown="ripple(event)" onclick="openBankApp('TCB','${nd}',${amount})">Techcombank</button>
            <button class="btn-ripple tap-btn" onmousedown="ripple(event)" onclick="openBankApp('BIDV','${nd}',${amount})">BIDV</button>
            <button class="btn-ripple tap-btn" onmousedown="ripple(event)" onclick="openBankApp('ACB','${nd}',${amount})">ACB</button>
            <button class="btn-ripple tap-btn" onmousedown="ripple(event)" onclick="openBankApp('VPB','${nd}',${amount})">VPBank NEO</button>
            <button class="btn-ripple tap-btn" onmousedown="ripple(event)" onclick="openBankApp('TPB','${nd}',${amount})">TPBank</button>
            <button class="btn-ripple tap-btn" onmousedown="ripple(event)" onclick="openBankApp('CTG','${nd}',${amount})">VietinBank</button>
          </div>
          <p class="text-xs subtle mt-2">(*) M·ªôt s·ªë app kh√¥ng cho ƒëi·ªÅn s·∫µn t·ª´ web ‚Äì ND & s·ªë ti·ªÅn ƒë√£ copy, b·∫°n ch·ªâ c·∫ßn d√°n.</p>
        </div>

        ${email?`<p class="text-sm subtle mt-3">Email kh√°ch: ${email}</p>`:""}
        <div class="mt-3 text-sm text-center">‚è≥ H·∫øt h·∫°n sau: <b id="countdown">15:00</b></div>
      </div>`;

    const cd=document.getElementById('countdown'), img=document.getElementById('qrImg');
    startCountdown(expireAt,(t)=>cd.textContent=t,()=>{
      img.classList.add('opacity-30','grayscale');
      cd.textContent="H·∫æT H·∫†N";
      const b=document.createElement('button');
      b.className='mt-3 btn-ripple tap-btn'; b.textContent='T·∫°o l·∫°i QR m·ªõi';
      b.onmousedown=ripple; b.onclick=()=>location.reload();
      document.getElementById('qrCard').appendChild(b);
    });
    window.scrollTo({top:wrap.offsetTop-8,behavior:'smooth'});
  }

  /* ===== Create QR ===== */
  document.getElementById('btnCreate').addEventListener('click',async ()=>{
    const product=document.getElementById('product').value.trim();
    const amount=Number(String(document.getElementById('amount').value).replace(/[^\d]/g,''));
    const email=document.getElementById('email').value.trim();
    const style=document.getElementById('qrStyle').value.trim();
    const autoCopy=(document.getElementById('autoCopy').value==='1');

    if(!amount || amount<10000){
      document.getElementById('amountErr').classList.remove('hidden');
      document.getElementById('amount').focus(); return;
    } else document.getElementById('amountErr').classList.add('hidden');

    const nd=makeND(product);
    const qrUrl=buildVietQR(nd, amount, style, currentBank);
    const expire=Date.now()+15*60*1000;

    if(autoCopy){ try{ await navigator.clipboard.writeText(nd);}catch(e){} }
    renderResult(nd, qrUrl, amount, email, expire, currentBank);
  });
</script>
</body>
</html>
